{"version":3,"file":"ng-util-lazy.js","sources":["../../../../packages/lazy/lazy.service.ts","../../../../packages/lazy/ng-util-lazy.ts"],"sourcesContent":["import { DOCUMENT } from '@angular/common';\nimport { Inject, Injectable } from '@angular/core';\nimport { BehaviorSubject, Observable, pipe } from 'rxjs';\nimport { filter, share } from 'rxjs/operators';\n\nexport type NuLazyResourcesType = 'script' | 'style';\n\nexport interface NuLazyResources {\n  path: string;\n  type: NuLazyResourcesType;\n  /**\n   * 回调名称\n   */\n  callback?: string;\n}\n\nexport interface NuLazyResult {\n  path: string;\n  status: 'ok' | 'error' | 'loading';\n  type?: NuLazyResourcesType;\n  error?: {};\n}\n\n@Injectable({ providedIn: 'root' })\nexport class NuLazyService {\n  private list: { [key: string]: boolean } = {};\n  private cached: { [key: string]: NuLazyResult } = {};\n  private _notify: BehaviorSubject<NuLazyResult[]> = new BehaviorSubject<NuLazyResult[]>([]);\n\n  constructor(@Inject(DOCUMENT) private doc: any) {}\n\n  private fixPaths(paths?: string | Array<string | NuLazyResources>): NuLazyResources[] {\n    paths = paths || [];\n    if (!Array.isArray(paths)) {\n      paths = [paths];\n    }\n    return paths.map((p: string | NuLazyResources) => {\n      const res = (typeof p === 'string' ? { path: p } : p) as NuLazyResources;\n      if (!res.type) {\n        res.type = res.path.endsWith('.js') || res.callback ? 'script' : 'style';\n      }\n      return res;\n    });\n  }\n\n  /**\n   * Monitor for the finished of `paths`\n   *\n   * - It's recommended to pass the value in accordance with the `load()` method\n   */\n  monitor(paths?: string | Array<string | NuLazyResources>): Observable<NuLazyResult[]> {\n    const libs = this.fixPaths(paths);\n\n    const pipes = [share(), filter((ls: NuLazyResult[]) => ls.length !== 0)];\n\n    if (libs.length > 0) {\n      pipes.push(\n        filter(\n          (ls: NuLazyResult[]) => ls.length === libs.length && ls.every(v => v.status === 'ok' && libs.find(lw => lw.path === v.path)),\n        ),\n      );\n    }\n\n    return this._notify.asObservable().pipe(pipe.apply(this, pipes as any) as any);\n  }\n\n  clear(): void {\n    this.list = {};\n    this.cached = {};\n  }\n\n  /**\n   * Load the specified resources, includes `.js`, `.css`\n   *\n   * - The returned Promise does not mean that it was successfully loaded\n   * - You can monitor load is success via `monitor()`\n   */\n  async load(paths: string | Array<string | NuLazyResources>): Promise<NuLazyResult[]> {\n    paths = this.fixPaths(paths);\n\n    return Promise.all(\n      (paths as NuLazyResources[]).map(p =>\n        p.type === 'script' ? this.loadScript(p.path, { callback: p.callback }) : this.loadStyle(p.path),\n      ),\n    ).then(res => {\n      this._notify.next(res);\n      return Promise.resolve(res);\n    });\n  }\n\n  loadScript(path: string, options?: { innerContent?: string; callback?: string }): Promise<NuLazyResult> {\n    const { innerContent } = { ...options };\n    return new Promise(resolve => {\n      if (this.list[path] === true) {\n        resolve({ ...this.cached[path], status: 'loading' });\n        return;\n      }\n\n      this.list[path] = true;\n      const onSuccess = (item: NuLazyResult) => {\n        if (item.status === 'ok' && options?.callback) {\n          (window as any)[options?.callback] = () => {\n            onSuccessTruth(item);\n          };\n        } else {\n          onSuccessTruth(item);\n        }\n      };\n      const onSuccessTruth = (item: NuLazyResult) => {\n        item.type = 'script';\n        this.cached[path] = item;\n        resolve(item);\n        this._notify.next([item]);\n      };\n\n      const node = this.doc.createElement('script') as any;\n      node.type = 'text/javascript';\n      node.src = path;\n      node.charset = 'utf-8';\n      if (innerContent) {\n        node.innerHTML = innerContent;\n      }\n      if (node.readyState) {\n        // IE\n        node.onreadystatechange = () => {\n          if (node.readyState === 'loaded' || node.readyState === 'complete') {\n            node.onreadystatechange = null;\n            onSuccess({\n              path,\n              status: 'ok',\n            });\n          }\n        };\n      } else {\n        node.onload = () =>\n          onSuccess({\n            path,\n            status: 'ok',\n          });\n      }\n      node.onerror = (error: {}) =>\n        onSuccess({\n          path,\n          status: 'error',\n          error,\n        });\n      this.doc.getElementsByTagName('head')[0].appendChild(node);\n    });\n  }\n\n  loadStyle(path: string, options?: { rel?: string; innerContent?: string }): Promise<NuLazyResult> {\n    const { rel, innerContent } = { rel: 'stylesheet', ...options };\n    return new Promise(resolve => {\n      if (this.list[path] === true) {\n        resolve(this.cached[path]);\n        return;\n      }\n\n      this.list[path] = true;\n\n      const node = this.doc.createElement('link') as HTMLLinkElement;\n      node.rel = rel;\n      node.type = 'text/css';\n      node.href = path;\n      if (innerContent) {\n        node.innerHTML = innerContent;\n      }\n      this.doc.getElementsByTagName('head')[0].appendChild(node);\n      const item: NuLazyResult = {\n        path,\n        status: 'ok',\n        type: 'style',\n      };\n      this.cached[path] = item;\n      resolve(item);\n    });\n  }\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":[],"mappings":"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"}