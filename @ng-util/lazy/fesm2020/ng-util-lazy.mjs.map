{"version":3,"file":"ng-util-lazy.mjs","sources":["../../../../packages/lazy/lazy.service.ts","../../../../packages/lazy/ng-util-lazy.ts"],"sourcesContent":["import { DOCUMENT } from '@angular/common';\nimport { Inject, Injectable } from '@angular/core';\nimport { BehaviorSubject, Observable, pipe } from 'rxjs';\nimport { filter, share } from 'rxjs/operators';\n\nexport type NuLazyResourcesType = 'script' | 'style';\n\nexport interface NuLazyResources {\n  path: string;\n  type: NuLazyResourcesType;\n  /**\n   * 回调名称\n   */\n  callback?: string;\n}\n\nexport interface NuLazyResult {\n  path: string;\n  status: 'ok' | 'error' | 'loading';\n  type?: NuLazyResourcesType;\n  error?: {};\n}\n\n@Injectable({ providedIn: 'root' })\nexport class NuLazyService {\n  private list: { [key: string]: boolean } = {};\n  private cached: { [key: string]: NuLazyResult } = {};\n  private _notify: BehaviorSubject<NuLazyResult[]> = new BehaviorSubject<NuLazyResult[]>([]);\n\n  constructor(@Inject(DOCUMENT) private doc: any) {}\n\n  private fixPaths(paths?: string | Array<string | NuLazyResources>): NuLazyResources[] {\n    paths = paths || [];\n    if (!Array.isArray(paths)) {\n      paths = [paths];\n    }\n    return paths.map((p: string | NuLazyResources) => {\n      const res = (typeof p === 'string' ? { path: p } : p) as NuLazyResources;\n      if (!res.type) {\n        res.type = res.path.endsWith('.js') || res.callback ? 'script' : 'style';\n      }\n      return res;\n    });\n  }\n\n  /**\n   * Monitor for the finished of `paths`\n   *\n   * - It's recommended to pass the value in accordance with the `load()` method\n   */\n  monitor(paths?: string | Array<string | NuLazyResources>): Observable<NuLazyResult[]> {\n    const libs = this.fixPaths(paths);\n\n    const pipes = [share(), filter((ls: NuLazyResult[]) => ls.length !== 0)];\n\n    if (libs.length > 0) {\n      pipes.push(\n        filter(\n          (ls: NuLazyResult[]) => ls.length === libs.length && ls.every(v => v.status === 'ok' && libs.find(lw => lw.path === v.path)),\n        ),\n      );\n    }\n\n    return this._notify.asObservable().pipe(pipe.apply(this, pipes as any) as any);\n  }\n\n  clear(): void {\n    this.list = {};\n    this.cached = {};\n  }\n\n  /**\n   * Load the specified resources, includes `.js`, `.css`\n   *\n   * - The returned Promise does not mean that it was successfully loaded\n   * - You can monitor load is success via `monitor()`\n   */\n  async load(paths: string | Array<string | NuLazyResources>): Promise<NuLazyResult[]> {\n    paths = this.fixPaths(paths);\n\n    return Promise.all(\n      (paths as NuLazyResources[]).map(p =>\n        p.type === 'script' ? this.loadScript(p.path, { callback: p.callback }) : this.loadStyle(p.path),\n      ),\n    ).then(res => {\n      this._notify.next(res);\n      return Promise.resolve(res);\n    });\n  }\n\n  loadScript(path: string, options?: { innerContent?: string; callback?: string }): Promise<NuLazyResult> {\n    const { innerContent } = { ...options };\n    return new Promise(resolve => {\n      if (this.list[path] === true) {\n        resolve({ ...this.cached[path], status: 'loading' });\n        return;\n      }\n\n      this.list[path] = true;\n      const onSuccess = (item: NuLazyResult) => {\n        if (item.status === 'ok' && options?.callback) {\n          (window as any)[options?.callback] = () => {\n            onSuccessTruth(item);\n          };\n        } else {\n          onSuccessTruth(item);\n        }\n      };\n      const onSuccessTruth = (item: NuLazyResult) => {\n        item.type = 'script';\n        this.cached[path] = item;\n        resolve(item);\n        this._notify.next([item]);\n      };\n\n      const node = this.doc.createElement('script') as any;\n      node.type = 'text/javascript';\n      node.src = path;\n      node.charset = 'utf-8';\n      if (innerContent) {\n        node.innerHTML = innerContent;\n      }\n      if (node.readyState) {\n        // IE\n        node.onreadystatechange = () => {\n          if (node.readyState === 'loaded' || node.readyState === 'complete') {\n            node.onreadystatechange = null;\n            onSuccess({\n              path,\n              status: 'ok',\n            });\n          }\n        };\n      } else {\n        node.onload = () =>\n          onSuccess({\n            path,\n            status: 'ok',\n          });\n      }\n      node.onerror = (error: {}) =>\n        onSuccess({\n          path,\n          status: 'error',\n          error,\n        });\n      this.doc.getElementsByTagName('head')[0].appendChild(node);\n    });\n  }\n\n  loadStyle(path: string, options?: { rel?: string; innerContent?: string }): Promise<NuLazyResult> {\n    const { rel, innerContent } = { rel: 'stylesheet', ...options };\n    return new Promise(resolve => {\n      if (this.list[path] === true) {\n        resolve(this.cached[path]);\n        return;\n      }\n\n      this.list[path] = true;\n\n      const node = this.doc.createElement('link') as HTMLLinkElement;\n      node.rel = rel;\n      node.type = 'text/css';\n      node.href = path;\n      if (innerContent) {\n        node.innerHTML = innerContent;\n      }\n      this.doc.getElementsByTagName('head')[0].appendChild(node);\n      const item: NuLazyResult = {\n        path,\n        status: 'ok',\n        type: 'style',\n      };\n      this.cached[path] = item;\n      resolve(item);\n    });\n  }\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":[],"mappings":";;;;;;MAwBa,aAAa,CAAA;AAKxB,IAAA,WAAA,CAAsC,GAAQ,EAAA;QAAR,IAAG,CAAA,GAAA,GAAH,GAAG,CAAK;QAJtC,IAAI,CAAA,IAAA,GAA+B,EAAE,CAAC;QACtC,IAAM,CAAA,MAAA,GAAoC,EAAE,CAAC;AAC7C,QAAA,IAAA,CAAA,OAAO,GAAoC,IAAI,eAAe,CAAiB,EAAE,CAAC,CAAC;KAEzC;AAE1C,IAAA,QAAQ,CAAC,KAAgD,EAAA;AAC/D,QAAA,KAAK,GAAG,KAAK,IAAI,EAAE,CAAC;AACpB,QAAA,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;AACzB,YAAA,KAAK,GAAG,CAAC,KAAK,CAAC,CAAC;AACjB,SAAA;AACD,QAAA,OAAO,KAAK,CAAC,GAAG,CAAC,CAAC,CAA2B,KAAI;YAC/C,MAAM,GAAG,IAAI,OAAO,CAAC,KAAK,QAAQ,GAAG,EAAE,IAAI,EAAE,CAAC,EAAE,GAAG,CAAC,CAAoB,CAAC;AACzE,YAAA,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE;gBACb,GAAG,CAAC,IAAI,GAAG,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,GAAG,CAAC,QAAQ,GAAG,QAAQ,GAAG,OAAO,CAAC;AAC1E,aAAA;AACD,YAAA,OAAO,GAAG,CAAC;AACb,SAAC,CAAC,CAAC;KACJ;AAED;;;;AAIG;AACH,IAAA,OAAO,CAAC,KAAgD,EAAA;QACtD,MAAM,IAAI,GAAG,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;QAElC,MAAM,KAAK,GAAG,CAAC,KAAK,EAAE,EAAE,MAAM,CAAC,CAAC,EAAkB,KAAK,EAAE,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC,CAAC;AAEzE,QAAA,IAAI,IAAI,CAAC,MAAM,GAAG,CAAC,EAAE;YACnB,KAAK,CAAC,IAAI,CACR,MAAM,CACJ,CAAC,EAAkB,KAAK,EAAE,CAAC,MAAM,KAAK,IAAI,CAAC,MAAM,IAAI,EAAE,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,CAAC,MAAM,KAAK,IAAI,IAAI,IAAI,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,CAAC,IAAI,KAAK,CAAC,CAAC,IAAI,CAAC,CAAC,CAC7H,CACF,CAAC;AACH,SAAA;AAED,QAAA,OAAO,IAAI,CAAC,OAAO,CAAC,YAAY,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE,KAAY,CAAQ,CAAC,CAAC;KAChF;IAED,KAAK,GAAA;AACH,QAAA,IAAI,CAAC,IAAI,GAAG,EAAE,CAAC;AACf,QAAA,IAAI,CAAC,MAAM,GAAG,EAAE,CAAC;KAClB;AAED;;;;;AAKG;IACH,MAAM,IAAI,CAAC,KAA+C,EAAA;AACxD,QAAA,KAAK,GAAG,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;QAE7B,OAAO,OAAO,CAAC,GAAG,CACf,KAA2B,CAAC,GAAG,CAAC,CAAC,IAChC,CAAC,CAAC,IAAI,KAAK,QAAQ,GAAG,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,IAAI,EAAE,EAAE,QAAQ,EAAE,CAAC,CAAC,QAAQ,EAAE,CAAC,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,IAAI,CAAC,CACjG,CACF,CAAC,IAAI,CAAC,GAAG,IAAG;AACX,YAAA,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AACvB,YAAA,OAAO,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;AAC9B,SAAC,CAAC,CAAC;KACJ;IAED,UAAU,CAAC,IAAY,EAAE,OAAsD,EAAA;QAC7E,MAAM,EAAE,YAAY,EAAE,GAAG,EAAE,GAAG,OAAO,EAAE,CAAC;AACxC,QAAA,OAAO,IAAI,OAAO,CAAC,OAAO,IAAG;YAC3B,IAAI,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,IAAI,EAAE;AAC5B,gBAAA,OAAO,CAAC,EAAE,GAAG,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC;gBACrD,OAAO;AACR,aAAA;AAED,YAAA,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC;AACvB,YAAA,MAAM,SAAS,GAAG,CAAC,IAAkB,KAAI;gBACvC,IAAI,IAAI,CAAC,MAAM,KAAK,IAAI,IAAI,OAAO,EAAE,QAAQ,EAAE;AAC5C,oBAAA,MAAc,CAAC,OAAO,EAAE,QAAQ,CAAC,GAAG,MAAK;wBACxC,cAAc,CAAC,IAAI,CAAC,CAAC;AACvB,qBAAC,CAAC;AACH,iBAAA;AAAM,qBAAA;oBACL,cAAc,CAAC,IAAI,CAAC,CAAC;AACtB,iBAAA;AACH,aAAC,CAAC;AACF,YAAA,MAAM,cAAc,GAAG,CAAC,IAAkB,KAAI;AAC5C,gBAAA,IAAI,CAAC,IAAI,GAAG,QAAQ,CAAC;AACrB,gBAAA,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC;gBACzB,OAAO,CAAC,IAAI,CAAC,CAAC;gBACd,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;AAC5B,aAAC,CAAC;YAEF,MAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,aAAa,CAAC,QAAQ,CAAQ,CAAC;AACrD,YAAA,IAAI,CAAC,IAAI,GAAG,iBAAiB,CAAC;AAC9B,YAAA,IAAI,CAAC,GAAG,GAAG,IAAI,CAAC;AAChB,YAAA,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;AACvB,YAAA,IAAI,YAAY,EAAE;AAChB,gBAAA,IAAI,CAAC,SAAS,GAAG,YAAY,CAAC;AAC/B,aAAA;YACD,IAAI,IAAI,CAAC,UAAU,EAAE;;AAEnB,gBAAA,IAAI,CAAC,kBAAkB,GAAG,MAAK;oBAC7B,IAAI,IAAI,CAAC,UAAU,KAAK,QAAQ,IAAI,IAAI,CAAC,UAAU,KAAK,UAAU,EAAE;AAClE,wBAAA,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC;AAC/B,wBAAA,SAAS,CAAC;4BACR,IAAI;AACJ,4BAAA,MAAM,EAAE,IAAI;AACb,yBAAA,CAAC,CAAC;AACJ,qBAAA;AACH,iBAAC,CAAC;AACH,aAAA;AAAM,iBAAA;AACL,gBAAA,IAAI,CAAC,MAAM,GAAG,MACZ,SAAS,CAAC;oBACR,IAAI;AACJ,oBAAA,MAAM,EAAE,IAAI;AACb,iBAAA,CAAC,CAAC;AACN,aAAA;YACD,IAAI,CAAC,OAAO,GAAG,CAAC,KAAS,KACvB,SAAS,CAAC;gBACR,IAAI;AACJ,gBAAA,MAAM,EAAE,OAAO;gBACf,KAAK;AACN,aAAA,CAAC,CAAC;AACL,YAAA,IAAI,CAAC,GAAG,CAAC,oBAAoB,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;AAC7D,SAAC,CAAC,CAAC;KACJ;IAED,SAAS,CAAC,IAAY,EAAE,OAAiD,EAAA;AACvE,QAAA,MAAM,EAAE,GAAG,EAAE,YAAY,EAAE,GAAG,EAAE,GAAG,EAAE,YAAY,EAAE,GAAG,OAAO,EAAE,CAAC;AAChE,QAAA,OAAO,IAAI,OAAO,CAAC,OAAO,IAAG;YAC3B,IAAI,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,IAAI,EAAE;gBAC5B,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC;gBAC3B,OAAO;AACR,aAAA;AAED,YAAA,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC;YAEvB,MAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,aAAa,CAAC,MAAM,CAAoB,CAAC;AAC/D,YAAA,IAAI,CAAC,GAAG,GAAG,GAAG,CAAC;AACf,YAAA,IAAI,CAAC,IAAI,GAAG,UAAU,CAAC;AACvB,YAAA,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC;AACjB,YAAA,IAAI,YAAY,EAAE;AAChB,gBAAA,IAAI,CAAC,SAAS,GAAG,YAAY,CAAC;AAC/B,aAAA;AACD,YAAA,IAAI,CAAC,GAAG,CAAC,oBAAoB,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;AAC3D,YAAA,MAAM,IAAI,GAAiB;gBACzB,IAAI;AACJ,gBAAA,MAAM,EAAE,IAAI;AACZ,gBAAA,IAAI,EAAE,OAAO;aACd,CAAC;AACF,YAAA,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC;YACzB,OAAO,CAAC,IAAI,CAAC,CAAC;AAChB,SAAC,CAAC,CAAC;KACJ;;AAxJU,mBAAA,aAAA,CAAA,IAAA,GAAA,EAAA,CAAA,kBAAA,CAAA,EAAA,UAAA,EAAA,QAAA,EAAA,OAAA,EAAA,QAAA,EAAA,QAAA,EAAA,EAAA,EAAA,IAAA,EAAA,aAAa,kBAKJ,QAAQ,EAAA,CAAA,EAAA,MAAA,EAAA,EAAA,CAAA,eAAA,CAAA,UAAA,EAAA,CAAA,CAAA;AALjB,mBAAA,aAAA,CAAA,KAAA,GAAA,EAAA,CAAA,qBAAA,CAAA,EAAA,UAAA,EAAA,QAAA,EAAA,OAAA,EAAA,QAAA,EAAA,QAAA,EAAA,EAAA,EAAA,IAAA,EAAA,aAAa,cADA,MAAM,EAAA,CAAA,CAAA;2FACnB,aAAa,EAAA,UAAA,EAAA,CAAA;kBADzB,UAAU;mBAAC,EAAE,UAAU,EAAE,MAAM,EAAE,CAAA;;0BAMnB,MAAM;2BAAC,QAAQ,CAAA;;;AC7B9B;;AAEG;;;;"}